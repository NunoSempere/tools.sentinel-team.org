<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter Tools - Sentinel Team</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Twitter Tools</h1>
        <p>Monitor and analyze Twitter accounts with AI-powered filtering</p>
    </header>

    <main>
        <section class="tool-section">
            <h2>Account Management</h2>
            <p>Add Twitter accounts to monitor. The backend fetcher will collect tweets every 10 minutes.</p>
            
            <div class="input-grid">
                <div class="input-group">
                    <label for="username-input">Twitter Username (without @):</label>
                    <input type="text" id="username-input" placeholder="elonmusk" aria-label="Twitter username">
                </div>
                <div class="input-group">
                    <label for="list-input">List Name (optional):</label>
                    <input type="text" id="list-input" placeholder="tech-leaders" aria-label="List name">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button id="add-account" class="primary-btn">Add Account</button>
                <button id="refresh-accounts" class="secondary-btn">Refresh Accounts List</button>
            </div>
            
            <div id="account-results" class="results-container"></div>
            
            <div id="accounts-list" class="results-container"></div>
        </section>

        <section class="tool-section">
            <h2>Tweet Retrieval</h2>
            <p>Retrieve tweets from monitored accounts or filter by list.</p>
            
            <div class="input-grid">
                <div class="input-group">
                    <label for="tweets-username">Specific Username (optional):</label>
                    <input type="text" id="tweets-username" placeholder="OpenAI" aria-label="Username for tweets">
                </div>
                <div class="input-group">
                    <label for="tweets-list">List Name (optional):</label>
                    <input type="text" id="tweets-list" placeholder="ai-companies" aria-label="List name for tweets">
                </div>
                <div class="input-group">
                    <label for="tweets-limit">Number of Tweets:</label>
                    <input type="number" id="tweets-limit" value="20" min="1" max="1000" aria-label="Number of tweets to retrieve">
                </div>
            </div>
            
            <button id="get-tweets" class="primary-btn">Get Tweets</button>
            
            <div id="tweets-results" class="results-container"></div>
        </section>

        <section class="tool-section">
            <h2>AI-Powered Tweet Filtering</h2>
            <p>Use natural language to filter tweets with GPT-4o-mini. Ask questions like "Does this tweet discuss AI research?" or "Is this tweet about cryptocurrency?"</p>
            
            <div class="input-container">
                <label for="filter-question">Filter Question:</label>
                <textarea 
                    id="filter-question" 
                    rows="3"
                    placeholder="Does this tweet discuss artificial intelligence or machine learning?"
                    aria-label="Question for filtering tweets"
                ></textarea>
            </div>
            
            <div class="input-container">
                <label for="filter-users">Twitter Usernames (one per line):</label>
                <textarea 
                    id="filter-users" 
                    rows="4"
                    placeholder="OpenAI&#10;AnthropicAI&#10;elonmusk&#10;ylecun"
                    aria-label="Twitter usernames one per line"
                ></textarea>
            </div>
            
            <button id="filter-tweets" class="primary-btn">Filter Tweets</button>
            
            <div id="filter-results" class="results-container"></div>
        </section>

        <section class="tool-section">
            <h2>API Status</h2>
            <p>Check the status of the Twitter API server.</p>
            
            <button id="check-health" class="primary-btn">Check API Health</button>
            
            <div id="health-results" class="results-container"></div>
        </section>
    </main>

    <script>
        const API_BASE = 'https://tweets.nunosempere.com/api';

        // DOM elements
        const usernameInput = document.getElementById('username-input');
        const listInput = document.getElementById('list-input');
        const addAccountBtn = document.getElementById('add-account');
        const refreshAccountsBtn = document.getElementById('refresh-accounts');
        const accountResultsDiv = document.getElementById('account-results');
        const accountsListDiv = document.getElementById('accounts-list');

        const tweetsUsernameInput = document.getElementById('tweets-username');
        const tweetsListInput = document.getElementById('tweets-list');
        const tweetsLimitInput = document.getElementById('tweets-limit');
        const getTweetsBtn = document.getElementById('get-tweets');
        const tweetsResultsDiv = document.getElementById('tweets-results');

        const filterQuestionInput = document.getElementById('filter-question');
        const filterUsersInput = document.getElementById('filter-users');
        const filterTweetsBtn = document.getElementById('filter-tweets');
        const filterResultsDiv = document.getElementById('filter-results');

        const checkHealthBtn = document.getElementById('check-health');
        const healthResultsDiv = document.getElementById('health-results');

        // Helper functions
        function showError(container, message) {
            container.innerHTML = `<div class="error">${message}</div>`;
            container.classList.add('show');
        }

        function showResults(container, html) {
            container.innerHTML = html;
            container.classList.add('show');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

        function truncateText(text, maxLength = 280) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Account Management
        addAccountBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const list = listInput.value.trim();

            if (!username) {
                showError(accountResultsDiv, 'Please enter a Twitter username.');
                return;
            }

            addAccountBtn.disabled = true;
            addAccountBtn.textContent = 'Adding...';

            try {
                const body = { username };
                if (list) body.list = list;

                const response = await fetch(`${API_BASE}/accounts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (result.success) {
                    showResults(accountResultsDiv, `
                        <div class="success">
                            Successfully added @${username}${list ? ` to list "${list}"` : ''}
                        </div>
                    `);
                    usernameInput.value = '';
                    listInput.value = '';
                    // Refresh accounts list
                    refreshAccountsBtn.click();
                } else {
                    showError(accountResultsDiv, result.message || 'Failed to add account');
                }
            } catch (error) {
                showError(accountResultsDiv, `Error: ${error.message}`);
            } finally {
                addAccountBtn.disabled = false;
                addAccountBtn.textContent = 'Add Account';
            }
        });

        refreshAccountsBtn.addEventListener('click', async () => {
            refreshAccountsBtn.disabled = true;
            refreshAccountsBtn.textContent = 'Loading...';

            try {
                const response = await fetch(`${API_BASE}/accounts`);
                const result = await response.json();

                if (result.success && result.data) {
                    const accounts = result.data;
                    if (accounts.length === 0) {
                        showResults(accountsListDiv, '<div>No accounts found. Add some accounts to get started!</div>');
                    } else {
                        let html = '<h3>Monitored Accounts</h3><ul class="results-list">';
                        accounts.forEach(account => {
                            html += `
                                <li>
                                    <span class="method-name">@${account.username}</span>
                                    <span class="method-value">${account.list || 'No list'}</span>
                                    <button onclick="deleteAccount('${account.username}')" class="secondary-btn" style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">Delete</button>
                                </li>
                            `;
                        });
                        html += '</ul>';
                        showResults(accountsListDiv, html);
                    }
                } else {
                    showError(accountsListDiv, result.message || 'Failed to load accounts');
                }
            } catch (error) {
                showError(accountsListDiv, `Error: ${error.message}`);
            } finally {
                refreshAccountsBtn.disabled = false;
                refreshAccountsBtn.textContent = 'Refresh Accounts List';
            }
        });

        // Delete account function (global scope for onclick)
        window.deleteAccount = async (username) => {
            if (!confirm(`Are you sure you want to delete @${username}?`)) return;

            try {
                const response = await fetch(`${API_BASE}/accounts/${username}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    refreshAccountsBtn.click();
                    showResults(accountResultsDiv, `
                        <div class="success">
                            Successfully deleted @${username}
                        </div>
                    `);
                } else {
                    showError(accountResultsDiv, result.message || 'Failed to delete account');
                }
            } catch (error) {
                showError(accountResultsDiv, `Error: ${error.message}`);
            }
        };

        // Tweet Retrieval
        getTweetsBtn.addEventListener('click', async () => {
            const username = tweetsUsernameInput.value.trim();
            const list = tweetsListInput.value.trim();
            const limit = parseInt(tweetsLimitInput.value) || 20;

            getTweetsBtn.disabled = true;
            getTweetsBtn.textContent = 'Loading tweets...';

            try {
                let url;
                if (username) {
                    url = `${API_BASE}/tweets/${username}?limit=${limit}`;
                } else {
                    url = `${API_BASE}/tweets?limit=${limit}`;
                    if (list) url += `&list=${list}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success && result.data) {
                    const tweets = result.data;
                    if (tweets.length === 0) {
                        showResults(tweetsResultsDiv, '<div>No tweets found. Make sure accounts are added and the fetcher has run.</div>');
                    } else {
                        let html = `<h3>Retrieved ${tweets.length} Tweets</h3>`;
                        tweets.forEach(tweet => {
                            html += `
                                <div style="border: 1px solid #e5e5e5; margin: 10px 0; padding: 15px; border-radius: 6px; background: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="color: #1a1a1a;">@${tweet.username}</strong>
                                        <span style="color: #666; font-size: 14px;">${formatDate(tweet.created_at)}</span>
                                    </div>
                                    <div style="line-height: 1.5; color: #1a1a1a;">${tweet.text}</div>
                                    ${tweet.tweet_id ? `<div style="margin-top: 10px; font-size: 12px; color: #666;">ID: ${tweet.tweet_id}</div>` : ''}
                                </div>
                            `;
                        });
                        showResults(tweetsResultsDiv, html);
                    }
                } else {
                    showError(tweetsResultsDiv, result.message || 'Failed to retrieve tweets');
                }
            } catch (error) {
                showError(tweetsResultsDiv, `Error: ${error.message}`);
            } finally {
                getTweetsBtn.disabled = false;
                getTweetsBtn.textContent = 'Get Tweets';
            }
        });

        // Tweet Filtering
        filterTweetsBtn.addEventListener('click', async () => {
            const question = filterQuestionInput.value.trim();
            const usersText = filterUsersInput.value.trim();

            if (!question) {
                showError(filterResultsDiv, 'Please enter a filter question.');
                return;
            }

            if (!usersText) {
                showError(filterResultsDiv, 'Please enter at least one Twitter username.');
                return;
            }

            const users = usersText.split('\n').map(u => u.trim()).filter(u => u);

            filterTweetsBtn.disabled = true;
            filterTweetsBtn.textContent = 'Filtering tweets...';

            try {
                const response = await fetch(`${API_BASE}/filter`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        users: users
                    })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const { filtered_tweets, count, question: usedQuestion } = result.data;
                    
                    let html = `
                        <h3>Filter Results</h3>
                        <p><strong>Question:</strong> ${usedQuestion}</p>
                        <p><strong>Found:</strong> ${count} matching tweets</p>
                    `;

                    if (filtered_tweets && filtered_tweets.length > 0) {
                        filtered_tweets.forEach(item => {
                            const tweet = item.tweet;
                            const passClass = item.pass ? 'success' : 'error';
                            const passText = item.pass ? '✓ PASS' : '✗ FAIL';
                            
                            html += `
                                <div style="border: 1px solid #e5e5e5; margin: 15px 0; padding: 15px; border-radius: 6px; background: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="color: #1a1a1a;">@${tweet.username}</strong>
                                        <div>
                                            <span class="${passClass}" style="padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold;">${passText}</span>
                                            <span style="color: #666; font-size: 14px; margin-left: 10px;">${formatDate(tweet.created_at)}</span>
                                        </div>
                                    </div>
                                    <div style="line-height: 1.5; color: #1a1a1a; margin-bottom: 10px;">${tweet.text}</div>
                                    <div style="background: #f8f8f8; padding: 10px; border-radius: 4px; font-style: italic; color: #666; border-left: 3px solid #ccc;">
                                        <strong>AI Reasoning:</strong> ${item.reasoning}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    showResults(filterResultsDiv, html);
                } else {
                    showError(filterResultsDiv, result.message || 'Failed to filter tweets');
                }
            } catch (error) {
                showError(filterResultsDiv, `Error: ${error.message}`);
            } finally {
                filterTweetsBtn.disabled = false;
                filterTweetsBtn.textContent = 'Filter Tweets';
            }
        });

        // Health Check
        checkHealthBtn.addEventListener('click', async () => {
            checkHealthBtn.disabled = true;
            checkHealthBtn.textContent = 'Checking...';

            try {
                const response = await fetch(`${API_BASE}/health`);
                const result = await response.json();

                if (result.success) {
                    showResults(healthResultsDiv, `
                        <div class="success">
                            ✓ API is healthy and running
                        </div>
                    `);
                } else {
                    showError(healthResultsDiv, 'API health check failed');
                }
            } catch (error) {
                showError(healthResultsDiv, `Error: ${error.message}`);
            } finally {
                checkHealthBtn.disabled = false;
                checkHealthBtn.textContent = 'Check API Health';
            }
        });

        // Keyboard shortcuts
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addAccountBtn.click();
            }
        });

        [tweetsUsernameInput, tweetsListInput, tweetsLimitInput].forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    getTweetsBtn.click();
                }
            });
        });

        filterQuestionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                filterTweetsBtn.click();
            }
        });

        filterUsersInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                filterTweetsBtn.click();
            }
        });

        // Auto-load accounts on page load
        window.addEventListener('load', () => {
            refreshAccountsBtn.click();
        });
    </script>
</body>
</html>